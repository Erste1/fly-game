<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GD Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; }
        #m { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); color: white; z-index: 100; }
        button { padding: 20px 50px; font-size: 30px; background: #2ecc71; color: white; border: none; border-radius: 10px; cursor: pointer; }
        #s { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 30px; z-index: 50; }
    </style>
</head>
<body>
    <div id="s">SCORE: 0</div>
    <div id="m">
        <h1 id="t">GEOMETRY DASH</h1>
        <button id="b" onclick="setup()">START</button>
    </div>
    <canvas id="c"></canvas>

    <script>
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('c'); // Исправлено на 2d ниже
        const scoreBox = document.getElementById('s');
        const draw = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameActive = false;
        let score = 0;
        let timer = 0;
        let obstacles = [];
        const ground = canvas.height - 100;

        const p = { x: 50, y: ground - 40, v: 0, rot: 0 };

        function setup() {
            // Полный сброс всего перед стартом
            obstacles = [];
            score = 0;
            timer = 0;
            p.y = ground - 40;
            p.v = 0;
            scoreBox.innerText = "SCORE: 0";
            
            document.getElementById('b').style.display = 'none';
            document.getElementById('t').innerText = "3... 2... 1...";
            
            // Ждем 1.5 секунды прежде чем вообще запустить движение
            setTimeout(() => {
                document.getElementById('m').style.display = 'none';
                gameActive = true;
            }, 1500);
        }

        function render() {
            draw.fillStyle = '#0072ff'; draw.fillRect(0, 0, canvas.width, canvas.height);
            draw.fillStyle = '#005bb5'; draw.fillRect(0, ground, canvas.width, 100);

            if (gameActive) {
                timer++;
                p.v += 0.8; p.y += p.v;

                if (p.y > ground - 40) { p.y = ground - 40; p.v = 0; p.rot = 0; }
                else { p.rot += 5; }

                // Спавн шипов ТОЛЬКО через 150 кадров после старта (это ~3 секунды)
                if (timer > 150 && timer % 120 === 0) {
                    obstacles.push({ x: canvas.width });
                }

                for (let i = obstacles.length - 1; i >= 0; i--) {
                    let o = obstacles[i];
                    o.x -= 7;

                    // Рисуем шип
                    draw.fillStyle = 'red';
                    draw.beginPath();
                    draw.moveTo(o.x, ground);
                    draw.lineTo(o.x + 20, ground - 40);
                    draw.lineTo(o.x + 40, ground);
                    draw.fill();

                    // ПРОВЕРКА СМЕРТИ (только если шип близко к игроку)
                    if (o.x < 150 && o.x > 20) {
                        if (p.y + 35 > ground - 35 && p.x + 35 > o.x + 5 && p.x < o.x + 35) {
                            gameActive = false;
                            document.getElementById('m').style.display = 'flex';
                            document.getElementById('b').style.display = 'block';
                            document.getElementById('t').innerText = "GAME OVER";
                        }
                    }

                    if (o.x < -50) {
                        obstacles.splice(i, 1);
                        score++;
                        scoreBox.innerText = "SCORE: " + score;
                    }
                }
            }

            // Игрок
            draw.save();
            draw.translate(p.x + 20, p.y + 20);
            draw.rotate(p.rot * Math.PI / 180);
            draw.fillStyle = '#0f0'; draw.fillRect(-20, -20, 40, 40);
            draw.strokeStyle = 'white'; draw.strokeRect(-20, -20, 40, 40);
            draw.restore();

            requestAnimationFrame(render);
        }

        const jump = () => { if (gameActive && p.y >= ground - 41) p.v = -12; };
        window.onmousedown = jump;
        window.ontouchstart = (e) => { e.preventDefault(); jump(); };

        render();
    </script>
</body>
</html>
