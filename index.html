<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GD Ultra Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #m { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); color: white; z-index: 100; }
        button { padding: 20px 50px; font-size: 30px; background: #2ecc71; color: white; border: none; border-radius: 10px; }
        #s { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 30px; z-index: 50; }
    </style>
</head>
<body>
    <div id="s">SCORE: 0</div>
    <div id="m">
        <h1 id="t">БЕЗОПАСНЫЙ СТАРТ</h1>
        <button id="b" onclick="st()">ИГРАТЬ</button>
    </div>
    <canvas id="c"></canvas>

    <script>
        const canvas = document.getElementById('c');
        const d = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let active = false;
        let score = 0;
        let t = 0;
        let obs = [];
        const g = canvas.height - 100;
        const p = { x: 50, y: g - 40, v: 0 };

        function st() {
            // Полная очистка при нажатии
            obs = [];
            score = 0;
            t = 0;
            p.y = g - 40;
            p.v = 0;
            document.getElementById('m').style.display = 'none';
            // Даем задержку в 100мс перед активацией логики
            setTimeout(() => { active = true; }, 100);
        }

        function run() {
            d.fillStyle = '#0072ff'; d.fillRect(0, 0, canvas.width, canvas.height);
            d.fillStyle = '#005bb5'; d.fillRect(0, g, canvas.width, 100);

            if (active) {
                t++;
                p.v += 0.8; p.y += p.v;

                if (p.y > g - 40) { p.y = g - 40; p.v = 0; }

                // СПАВН ТОЛЬКО ПОСЛЕ 200 КАДРОВ (~4 СЕКУНДЫ)
                if (t > 200 && t % 120 === 0) {
                    obs.push({ x: canvas.width });
                }

                for (let i = obs.length - 1; i >= 0; i--) {
                    obs[i].x -= 7;
                    d.fillStyle = 'red';
                    d.beginPath();
                    d.moveTo(obs[i].x, g);
                    d.lineTo(obs[i].x + 20, g - 40);
                    d.lineTo(obs[i].x + 40, g);
                    d.fill();

                    // Проверка смерти
                    if (obs[i].x < 90 && obs[i].x > 10) {
                        if (p.y + 35 > g - 35) {
                            active = false;
                            document.getElementById('m').style.display = 'flex';
                            document.getElementById('t').innerText = "GAME OVER";
                            document.getElementById('b').innerText = "TRY AGAIN";
                        }
                    }

                    if (obs[i].x < -50) {
                        obs.splice(i, 1);
                        score++;
                        document.getElementById('s').innerText = "SCORE: " + score;
                    }
                }
            }

            d.fillStyle = '#0f0';
            d.fillRect(p.x, p.y, 40, 40);
            d.strokeRect(p.x, p.y, 40, 40);

            requestAnimationFrame(run);
        }

        window.onclick = () => { if (active && p.y >= g - 41) p.v = -12; };
        run();
    </script>
</body>
</html>
